<!DOCTYPE html>
<meta charset="utf-8" />
<title>WebSocket Test</title>
<!--
	版本：1.0<br/>
	作者：OKCoin<br/>
-->
<script type="text/javascript" src="MD5.js"></script>
<script type="text/javascript">
	var okCoinWebSocket = {};
	okCoinWebSocket.init = function(uri, apiKey, secretKey) {
		this.wsUri = uri;
		this.api_key = apiKey;
		this.secret_key = secretKey;
		this.lastHeartBeat = new Date().getTime();
		this.overtime = 8000;
		okCoinWebSocket.websocket = new WebSocket(okCoinWebSocket.wsUri);
		
		okCoinWebSocket.websocket.onopen = function(evt) {
			onOpen(evt)
		};
		okCoinWebSocket.websocket.onclose = function(evt) {
			onClose(evt)
		};
		okCoinWebSocket.websocket.onmessage = function(evt) {
			onMessage(evt)
		};
		okCoinWebSocket.websocket.onerror = function(evt) {
			onError(evt)
		};
		
		//setInterval(checkConnect,5000);
	}

	function checkConnect() {
		websocket.send("{'event':'ping'}");
		if ((new Date().getTime() - okCoinWebSocket.lastHeartBeat) > okCoinWebSocket.overtime) {
			onsole.log("socket 连接断开，正在尝试重新建立连接");
			//testWebSocket();
		}
	}

	function onOpen(evt) {
		print("CONNECTED");

		//doSend("{'event':'addChannel','channel':'ok_sub_spotcny_btc_kline_1min'}");
		//现货交易、合约交易测试
		//tradeTest();
		
		//********                            测试数据                                                                 *******/
		//////////////////现货行情//////////////////////////////////////////////////
		//doSend("{'event':'addChannel','channel':'ok_sub_spotusd_btc_ticker'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_spotusd_ltc_ticker'}");
		
		//doSend("{'event':'addChannel','channel':'ok_sub_spotusd_btc_depth_20'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_spotusd_btc_depth_60'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_spotusd_ltc_depth_20'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_spotusd_ltc_depth_60'}");
		
		//doSend("{'event':'addChannel','channel':'ok_sub_spotusd_btc_trades'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_spotusd_ltc_trades'}");
		
		//doSend("{'event':'addChannel','channel':'ok_btcusd_kline_3min'}");
		
		//doSend("{'event':'addChannel','channel':'ok_sub_spotusd_btc_kline_1min'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_spotusd_btc_kline_3min'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_spotusd_btc_kline_5min'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_spotusd_btc_kline_15min'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_spotusd_btc_kline_30min'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_spotusd_btc_kline_1hour'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_spotusd_btc_kline_2hour'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_spotusd_btc_kline_4hour'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_spotusd_btc_kline_6hour'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_spotusd_btc_kline_12hour'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_spotusd_btc_kline_day'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_spotusd_btc_kline_3day'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_spotusd_btc_kline_week'}");
		
		//doSend("{'event':'addChannel','channel':'ok_sub_spotusd_ltc_kline_1min'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_spotusd_ltc_kline_3min'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_spotusd_ltc_kline_5min'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_spotusd_ltc_kline_15min'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_spotusd_ltc_kline_30min'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_spotusd_ltc_kline_1hour'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_spotusd_ltc_kline_2hour'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_spotusd_ltc_kline_4hour'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_spotusd_ltc_kline_6hour'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_spotusd_ltc_kline_12hour'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_spotusd_ltc_kline_day'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_spotusd_ltc_kline_3day'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_spotusd_ltc_kline_week'}");
		//////////////////现货行情//////////////////////////////////////////////////
		
		//////////////合约行情//////////////////////////////////////////////////////
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_btc_ticker_this_week'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_btc_ticker_next_week'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_btc_ticker_quarter'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_ltc_ticker_this_week'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_ltc_ticker_next_week'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_ltc_ticker_quarter'}");
		
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_btc_kline_this_week_1min'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_btc_kline_this_week_3min'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_btc_kline_this_week_5min'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_btc_kline_this_week_15min'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_btc_kline_this_week_30min'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_btc_kline_this_week_1hour'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_btc_kline_this_week_2hour'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_btc_kline_this_week_4hour'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_btc_kline_this_week_6hour'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_btc_kline_this_week_12hour'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_btc_kline_this_week_day'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_btc_kline_this_week_3day'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_btc_kline_this_week_week'}");
		
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_btc_kline_next_week_1min'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_btc_kline_quarter_1min'}");
		
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_ltc_kline_this_week_1min'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_ltc_kline_next_week_1min'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_ltc_kline_quarter_1min'}");

		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_btc_depth_this_week_20'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_btc_depth_this_week_60'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_btc_depth_next_week_20'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_btc_depth_next_week_60'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_btc_depth_quarter_20'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_btc_depth_quarter_60'}");

		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_ltc_depth_this_week_20'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_ltc_depth_this_week_60'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_ltc_depth_next_week_20'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_ltc_depth_next_week_60'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_ltc_depth_quarter_20'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_ltc_depth_quarter_60'}");

		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_btc_trade_this_week'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_btc_trade_next_week'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_btc_trade_quarter'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_ltc_trade_this_week'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_ltc_trade_next_week'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_ltc_trade_quarter'}");
		
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_btc_index'}");
		//doSend("{'event':'addChannel','channel':'ok_sub_futureusd_ltc_index'}");
		//////////////合约行情//////////////////////////////////////////////////////
		tradeTest();
	}
	
	function tradeTest(){
		//现货交易
		//spotTrade();
		//spotCancelOrder(100);
		//spotUserInfo();
		//spotOrderInfo();
		//spotTrades();
		//spotUserinfos();
		
		//合约交易
		//futureTrade();
    futureOrderInfo(-1);
		//futureCancelOrder(4394829882);
		//futureUserInfo();
		//futureOrderInfo(-1);
		//futureTrades();
		//futureUserinfos();
		futurePositions();
    futureTrades();

	}

	function onClose(evt) {
		print("DISCONNECTED");
	}
  /*
  # Request
{
    'event':'addChannel',
    'channel':'ok_sub_futureusd_positions',
    'parameters':{
        'api_key':'XXXX',
        'sign':'XXXX'
    }
}
# Response
[{
    "channel": "ok_sub_futureusd_positions",
    "data": {
        "positions": [{
            "contract_id": "20160108116",
            "contract_name": "LTC0108",
            "avgprice": "3.488",
            "balance": "0.40390746",
            "bondfreez": "0",
            "costprice": "3.488",
            "eveningup": "1",
            "forcedprice": "3.20008407",
            "position": "1",
            "profitreal": "-0.11729238",
            "fixmargin": "0.28661508",
            "hold_amount": "1",
            "lever_rate": "10",
            "position_id": "8166976"
        }],
        "symbol": "ltc_usd"
    }
}]
*/

  function onMessage(e) {
    console.log(new Date().getTime() + ": " + e.data);
    var array = JSON.parse(e.data);
    if(array[0].channel=='ok_futureusd_orderinfo'){
      createTable(array); 
    }

    if(array[0].channel=='ok_sub_futureusd_positions'){
      if(array[0].success){
        //console.log(array[0].success);
      }else if(array[0].data){
        for ( var i in array[0].data.positions) {
          //console.log(array[0].data.positions[i]);
          var levier = Number(array[0].data.positions[i].lever_rate);
          var price = Number(array[0].data.positions[i].avgprice);
          var hold_amount = Number(array[0].data.positions[i].hold_amount);
          var forcedprice = Number(array[0].data.positions[i].forcedprice);
          if(forcedprice<price){
            type=3;
          }else if(forcedprice>price){
            type=4;
          }
          var p1 = (2/100/levier*price)+price;
          //console.log(p1);
          var p2 = p1+price*(levier-1)/levier*0.0003;
          console.log("price: "+p2+" hold_amount: "+hold_amount+ " levier: "+levier+" old price: "+price+" type:"+type);
          futureTrade("quarter", 100, p2, type, levier);
        }
      }
      
    }
    

    if (array.event == 'pong') {
      okCoinWebSocket.lastHeartBeat = new Date().getTime();
    }

  }

	function onError(evt) {
		print('<span style="color: red;">ERROR:</span> ' + evt.data);
	}

	function doSend(message) {
		print("SENT: " + message);
		okCoinWebSocket.websocket.send(message);
	}

	function print(message) {
		var status = document.getElementById("status");
		status.style.wordWrap = "break-word";
		status.innerHTML += message + "<br/>";
	}
	
  function createTable(array) {
    for ( var i in array[0].data.orders) {
      console.log(array[0].data.orders[i]);
      var levier = array[0].data.orders[i].lever_rate;
      var price = array[0].data.orders[i].price;
      var p1 = (2/100/levier*price)+price;
      console.log(p1);
      var p2 = p1+price*(levier-1)/levier*0.0003;
      console.log(p2);
    }
  }

	//现货下单
	function spotTrade() {
		var sign = MD5("amount=0.1&api_key=" + okCoinWebSocket.api_key
				+ "&symbol=ltc_usd&type=sell_market&secret_key=" + okCoinWebSocket.secret_key);
		doSend("{'event':'addChannel','channel':'ok_spotusd_trade','parameters':{'api_key':'" + okCoinWebSocket.api_key
				+ "','sign':'" + sign + "','symbol':'ltc_usd','type':'sell_market','amount':0.1}}");
	}

	//现货取消订单
	function spotCancelOrder(orderId) {
		var sign = MD5("api_key=" + okCoinWebSocket.api_key + "&order_id=" + orderId
				+ "&symbol=ltc_usd&secret_key=" + okCoinWebSocket.secret_key);
		doSend("{'event':'addChannel','channel':'ok_spotusd_cancel_order','parameters':{'api_key':'" + okCoinWebSocket.api_key
				+ "','sign':'" + sign + "','symbol':'ltc_usd','order_id':'" + orderId + "'}}");
	}

	//现货个人信息
	function spotUserInfo() {
		var sign = MD5("api_key=" + okCoinWebSocket.api_key + "&secret_key=" + okCoinWebSocket.secret_key);
		doSend("{'event':'addChannel','channel':'ok_spotusd_userinfo','parameters' :{'api_key':'"
				+ okCoinWebSocket.api_key + "','sign':'" + sign + "'}}");
	}
	
	//查询订单信息
	function spotOrderInfo(){
		var sign = MD5("api_key=" + okCoinWebSocket.api_key + "&order_id=20914907&secret_key=" + okCoinWebSocket.secret_key + "&symbol=ltc_usd");
		doSend("{'event':'addChannel','channel':'ok_spotusd_orderinfo','parameters' :{'api_key':'"
				+ okCoinWebSocket.api_key + "','symbol':'ltc_usd','order_id':'20914907','sign':'" + sign + "'}}");
	}
	//订阅交易数据
	function spotTrades() {
		var sign = MD5("api_key=" + okCoinWebSocket.api_key + "&secret_key=" + okCoinWebSocket.secret_key);
		doSend("{'event':'addChannel','channel':'ok_sub_spotusd_trades','parameters' :{'api_key':'"
				+ okCoinWebSocket.api_key + "','sign':'" + sign + "'}}");
	}
	//订阅账户信息
	function spotUserinfos() {
		var sign = MD5("api_key=" + okCoinWebSocket.api_key + "&secret_key=" + okCoinWebSocket.secret_key);
		doSend("{'event':'addChannel','channel':'ok_sub_spotusd_userinfo','parameters' :{'api_key':'"
				+ okCoinWebSocket.api_key + "','sign':'" + sign + "'}}");
	}

	//合约下单
	function futureTrade(contract_type, amount, price, type, lever_rate) {
		var sign = MD5("amount=1&api_key=" + okCoinWebSocket.api_key + 
				"&contract_type="+contract_type+"&lever_rate="+lever_rate+"&match_price=0&price="+price+"&symbol=btc_usd&type="+type+"&secret_key=" + okCoinWebSocket.secret_key);
		console.log('trade');
    doSend("{'event': 'addChannel','channel':'ok_futureusd_trade','parameters': {'api_key': '"
				+ okCoinWebSocket.api_key + "','sign': '" + sign + "','symbol': 'btc_usd','contract_type':"+contract_type+",'amount':"+amount+",'price':"+price+",'type':"+type+",'match_price': '0','lever_rate':"+lever_rate+"}}");
	}

	//合约取消订单
	function futureCancelOrder(orderId) {
		var sign = MD5("api_key=" + okCoinWebSocket.api_key + "&contract_type=quarter&order_id=" + orderId
				+ "&symbol=btc_usd&secret_key=" + okCoinWebSocket.secret_key);
		doSend("{'event': 'addChannel','channel': 'ok_futureusd_cancel_order','parameters': {'api_key': '"
				+ okCoinWebSocket.api_key + "','sign': '" + sign + "','symbol': 'btc_usd','order_id': '" + orderId
				+ "','contract_type': 'quarter'}}");
	}

	//合约个人信息
	function futureUserInfo() {
				console.log(okCoinWebSocket.api_key);
		console.log(okCoinWebSocket.secret_key);
		var sign = MD5("api_key=" + okCoinWebSocket.api_key + "&secret_key=" + okCoinWebSocket.secret_key);
		doSend("{'event':'addChannel','channel':'ok_futureusd_userinfo','parameters' :{'api_key':'"
				+ okCoinWebSocket.api_key + "','sign':'" + sign + "'}}");
	}

	//Pour connaitre l'ensemble des ordres en attente : orderId = -1
	function futureOrderInfo(orderId) {
		var sign = MD5("api_key=" + okCoinWebSocket.api_key + "&contract_type=quarter&current_page=1&order_id=" + orderId
				+ "&page_length=50&status=1&symbol=btc_usd&secret_key=" + okCoinWebSocket.secret_key);
		doSend("{'event': 'addChannel','channel': 'ok_futureusd_orderinfo','parameters': {'api_key': '"
				+ okCoinWebSocket.api_key + "','sign': '" + sign + "','symbol': 'btc_usd','order_id': '" + orderId
				+ "','contract_type': 'quarter','status':'1','current_page':'1','page_length':'50'}}");
	}
	
	//订阅合约交易数据
	function futureTrades() {
		var sign = MD5("api_key=" + okCoinWebSocket.api_key + "&secret_key=" + okCoinWebSocket.secret_key);
		doSend("{'event':'addChannel','channel':'ok_sub_futureusd_trades','parameters' :{'api_key':'"
				+ okCoinWebSocket.api_key + "','sign':'" + sign + "'}}");
	}
	
	//订阅合约账户信息
	function futureUserinfos() {
		var sign = MD5("api_key=" + okCoinWebSocket.api_key + "&secret_key=" + okCoinWebSocket.secret_key);
		doSend("{'event':'addChannel','channel':'ok_sub_futureusd_userinfo','parameters' :{'api_key':'"
				+ okCoinWebSocket.api_key + "','sign':'" + sign + "'}}");
	}
	
	//订阅合约持仓信息
	function futurePositions() {
		var sign = MD5("api_key=" + okCoinWebSocket.api_key + "&secret_key=" + okCoinWebSocket.secret_key);
		doSend("{'event':'addChannel','channel':'ok_sub_futureusd_positions','parameters' :{'api_key':'"
				+ okCoinWebSocket.api_key + "','sign':'" + sign + "'}}");
	}

	function connect(){
		//console.log(document.getElementById("api_key").value);
		//console.log(document.getElementById("secret").value);
		okCoinWebSocket.init("wss://real.okcoin.com:10440/websocket/okcoinapi", document.getElementById("api_key").value, document.getElementById("secret").value);

	}

	
</script>
<body>
<h2 id="th2">WebSocket Test</h2>
API KEY: <input type="text" name="api_key" id="api_key"/><br><br>
SECRET: <input type="text" name="secret" id="secret"/><br><br>
 <button type="button" onclick="connect()">Connect!</button> <br><br>
<div id="status"></div>
<div id="output"></div>
</body>
</html>
